import yfinance as yf
import pandas as pd
import time

SP500_URL = 'https://en.wikipedia.org/wiki/List_of_S%26P_500_companies'

def get_sp500_tickers():
    tables = pd.read_html(SP500_URL)
    return tables[0]['Symbol'].tolist()
	
def fetch_yfinance_data(symbols, start_date, end_date, interval):
    results = {}
    for symbol in symbols:
        try:
            df = yf.download(
                tickers=symbol,
                start=start_date,
                end=end_date,
                interval=interval,
                progress=False,
                ignore_tz=True
            )
            if not df.empty:
                results[symbol] = df
        except Exception as e:
            error_logger.error(f"{symbol} fetch error: {e}")
    return results


def transform_data(df, symbol):
    df.columns = [col[0] for col in df.columns]
    df = df.reset_index()
    print(df)
    # df = df[df["Close"] != 0]
    df["symbol"] = symbol
    df['close_change'] = df['Close'].diff().fillna(0)
    df['close_pct_change'] = df['Close'].pct_change().fillna(0) * 100
    return df[['Date', 'Close', 'High', 'Low', 'Open', 'Volume', 'symbol', 'close_change', 'close_pct_change']]
